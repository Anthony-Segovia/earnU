"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,n=(e=require("regenerator-runtime"))&&"object"==typeof e&&"default"in e?e.default:e,t=require("@stacks/auth"),r=require("jsontokens"),o=require("@stacks/transactions"),s=require("@stacks/network"),a=require("@stacks/connect-ui/loader"),i=require("@stacks/connect-ui/dist/components/connect-modal");function u(e,n,t,r,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?n(u):Promise.resolve(u).then(r,o)}function c(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function a(e){u(s,r,o,a,i,"next",e)}function i(e){u(s,r,o,a,i,"throw",e)}a(void 0)}))}}function p(){return(p=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}function l(e,n){if(null==e)return{};var t,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)n.indexOf(t=s[r])>=0||(o[t]=e[t]);return o}function f(){return window.StacksProvider||window.BlockstackProvider}"undefined"!=typeof window&&(window.__CONNECT_VERSION__="6.8.6");var d,v,h=function(){var e=navigator.userAgent;return!!/android/i.test(e)||!!/iPad|iPhone|iPod/.test(e)||/windows phone/i.test(e)},x=function(e){if(!e){var n=new t.AppConfig(["store_write"],document.location.href);e=new t.UserSession({appConfig:n})}return e},y=function(){var e=c(n.mark((function e(t){var o,s,a,i,u,c,p,l,d,v,h,y,w,k,g;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=f()){e.next=3;break}throw new Error("Unable to authenticate without Hiro Wallet extension");case 3:return a=void 0===(s=t.redirectTo)?"/":s,i=t.manifestPath,u=t.onFinish,c=t.onCancel,l=void 0!==(p=t.sendToSignIn)&&p,d=t.appDetails,(v=x(t.userSession)).isUserSignedIn()&&v.signUserOut(),h=v.generateAndStoreTransitKey(),y=v.makeAuthRequest(h,""+document.location.origin+a,""+document.location.origin+i,v.appConfig.scopes,void 0,void 0,{sendToSignIn:l,appDetails:d,connectVersion:"6.8.6"}),e.prev=8,e.next=11,o.authenticationRequest(y);case 11:return w=e.sent,e.next=14,v.handlePendingSignIn(w);case 14:k=r.decodeToken(w),g=null==k?void 0:k.payload,null==u||u({authResponse:w,authResponsePayload:g,userSession:v}),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(8),console.error("[Connect] Error during auth request",e.t0),null==c||c();case 24:case"end":return e.stop()}}),e,null,[[8,20]])})));return function(n){return e.apply(this,arguments)}}(),w=function(){var e=c(n.mark((function e(t){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=x(t)).isUserSignedIn()){e.next=3;break}return e.abrupt("return",t.loadUserData());case 3:if(!t.isSignInPending()){e.next=5;break}return e.abrupt("return",t.handlePendingSignIn());case 5:return e.abrupt("return",null);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();(d=exports.TransactionTypes||(exports.TransactionTypes={})).ContractCall="contract_call",d.ContractDeploy="smart_contract",d.STXTransfer="token_transfer",(v=exports.ContractCallArgumentType||(exports.ContractCallArgumentType={})).BUFFER="buffer",v.UINT="uint",v.INT="int",v.PRINCIPAL="principal",v.BOOL="bool";var k=["functionArgs","appDetails","userSession"],g=["appDetails","userSession"],m=["amount","appDetails","userSession"],S=function(e){var n=e;if(!n){var r=new t.AppConfig(["store_write"],document.location.href);n=new t.UserSession({appConfig:r})}return n};function b(e){try{return S(e).loadUserData(),!0}catch(e){return!1}}var C=function(e){var n=S(e).loadUserData().appPrivateKey;return{privateKey:n,publicKey:r.SECP256K1Client.derivePublicKey(n)}};function T(e){var n,t,r=e.stxAddress,s=e.userSession,a=e.network;if(r)return r;if(s&&a){var i=null==s||null==(n=s.loadUserData().profile)?void 0:n.stxAddress,u=((t={})[o.ChainID.Mainnet]="mainnet",t[o.ChainID.Testnet]="testnet",t);return null==i?void 0:i[u[a.chainId]]}}function D(e){var n=e.network||new s.StacksTestnet;if(b(e.userSession)){var t=p({},e,{network:n,userSession:S(e.userSession)});return p({stxAddress:T(t)},t)}if(!("stxAddress"in e))throw new Error("Must set property `stxAddress` when using `stx_requestAccounts to initiate transaction`");return p({},e,{network:n})}function E(e){return e.map((function(e){return o.serializePostCondition(e).toString("hex")}))}function A(e,n){return P.apply(this,arguments)}function P(){return(P=c(n.mark((function e(t,o){var s,a;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(s=t.postConditions)&&"string"!=typeof s[0]&&(s=E(s)),a=new r.TokenSigner("ES256k",o),e.abrupt("return",a.signAsync(p({},t,{postConditions:s})));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function K(e){var n=e.postConditions;return n&&"string"!=typeof n[0]&&(n=E(n)),r.createUnsecuredToken(p({},e,{postConditions:n}))}var q=function(){var e=c(n.mark((function e(t){var r,s,a,i,u,c;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.token,s=t.options,a=f()){e.next=4;break}throw new Error("Hiro Wallet not installed");case 4:return e.prev=4,e.next=7,a.transactionRequest(r);case 7:if(i=e.sent,u=Buffer.from(i.txRaw.replace(/^0x/,""),"hex"),c=o.deserializeTransaction(new o.BufferReader(u)),!("sponsored"in s)||!s.sponsored){e.next=14;break}return null==s.onFinish||s.onFinish(p({},i,{stacksTransaction:c})),e.abrupt("return");case 14:null==s.onFinish||s.onFinish(p({},i,{stacksTransaction:c})),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(4),console.error("[Connect] Error during transaction request",e.t0),null==s.onCancel||s.onCancel();case 21:case"end":return e.stop()}}),e,null,[[4,17]])})));return function(n){return e.apply(this,arguments)}}(),I=function(){var e=c(n.mark((function e(t){var r,s,a,i,u,c,f,d,v;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.functionArgs,s=t.appDetails,a=t.userSession,i=l(t,k),u=r.map((function(e){return"string"==typeof e?e:o.serializeCV(e).toString("hex")})),!b(a)){e.next=7;break}return c=C(a),f=c.privateKey,d=p({},i,{functionArgs:u,txType:exports.TransactionTypes.ContractCall,publicKey:c.publicKey}),s&&(d.appDetails=s),e.abrupt("return",A(d,f));case 7:return v=p({},i,{functionArgs:u,txType:exports.TransactionTypes.ContractCall}),s&&(v.appDetails=s),e.abrupt("return",K(v));case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),U=function(){var e=c(n.mark((function e(t){var r,o,s,a,i,u,c;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.appDetails,o=t.userSession,s=l(t,g),!b(o)){e.next=6;break}return a=C(o),i=a.privateKey,u=p({},s,{publicKey:a.publicKey,txType:exports.TransactionTypes.ContractDeploy}),r&&(u.appDetails=r),e.abrupt("return",A(u,i));case 6:return c=p({},s,{txType:exports.TransactionTypes.ContractDeploy}),r&&(c.appDetails=r),e.abrupt("return",K(c));case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),O=function(){var e=c(n.mark((function e(t){var r,o,s,a,i,u,c,f,d;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.amount,o=t.appDetails,s=t.userSession,a=l(t,m),!b(s)){e.next=6;break}return i=C(s),u=i.privateKey,c=i.publicKey,f=p({},a,{amount:r.toString(10),publicKey:c,txType:exports.TransactionTypes.STXTransfer}),o&&(f.appDetails=o),e.abrupt("return",A(f,u));case 6:return d=p({},a,{amount:r.toString(10),txType:exports.TransactionTypes.STXTransfer}),o&&(d.appDetails=o),e.abrupt("return",K(d));case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();function R(e,n){return _.apply(this,arguments)}function _(){return(_=c(n.mark((function e(t,r){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r(p({},D(t),t));case 2:return e.abrupt("return",q({token:e.sent,options:t}));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var F=["userSession"];function j(e){var n,t,r=e.userSession,s=e.network;if(r&&s){var a=null==r||null==(n=r.loadUserData().profile)?void 0:n.stxAddress,i=((t={})[o.ChainID.Mainnet]="mainnet",t[o.ChainID.Testnet]="testnet",t);return null==a?void 0:a[i[s.chainId]]}}function M(e){var n=p({},e,{network:e.network||new s.StacksTestnet,userSession:S(e.userSession)});return p({stxAddress:j(n)},n)}function L(e,n){return B.apply(this,arguments)}function B(){return(B=c(n.mark((function e(t,o){var s;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=new r.TokenSigner("ES256k",o),e.abrupt("return",s.signAsync(p({},t)));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function N(e){return W.apply(this,arguments)}function W(){return(W=c(n.mark((function e(t){var r,o,s,a;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.token,o=t.options,s=f()){e.next=4;break}throw new Error("Hiro Wallet not installed.");case 4:return e.prev=4,e.next=7,s.signatureRequest(r);case 7:a=e.sent,null==o.onFinish||o.onFinish(a),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(4),console.error("[Connect] Error during signature request",e.t0),null==o.onCancel||o.onCancel();case 15:case"end":return e.stop()}}),e,null,[[4,11]])})))).apply(this,arguments)}var X=function(){var e=c(n.mark((function e(t){var r,o,s,a,i;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.userSession,o=l(t,F),s=C(r),a=s.privateKey,i=p({},o,{publicKey:s.publicKey}),e.abrupt("return",L(i,a));case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();function z(){return(z=c(n.mark((function e(t,r){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r(p({},M(t),t));case 2:return e.abrupt("return",N({token:e.sent,options:t}));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var H=["userSession"];function V(){return(V=c(n.mark((function e(t,r){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r(p({},M(t),t));case 2:return e.abrupt("return",Z({token:e.sent,options:t}));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(e,n){return J.apply(this,arguments)}function J(){return(J=c(n.mark((function e(t,s){var a;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new r.TokenSigner("ES256k",s),e.abrupt("return",a.signAsync(p({},t,{message:o.serializeCV(t.message).toString("hex")})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Q(e){return Y.apply(this,arguments)}function Y(){return(Y=c(n.mark((function e(t){var r,o,s,a,i;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.userSession,o=l(t,H),s=C(r),a=s.privateKey,i=p({},o,{publicKey:s.publicKey}),e.abrupt("return",G(i,a));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e){return $.apply(this,arguments)}function $(){return($=c(n.mark((function e(t){var r,o,s,a;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.token,o=t.options,s=f()){e.next=4;break}throw new Error("Hiro Wallet not installed.");case 4:return e.prev=4,e.next=7,s.structuredDataSignatureRequest(r);case 7:a=e.sent,null==o.onFinish||o.onFinish(a),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(4),console.error("[Connect] Error during signature request",e.t0),null==o.onCancel||o.onCancel();case 15:case"end":return e.stop()}}),e,null,[[4,11]])})))).apply(this,arguments)}var ee=function(e){if(f())y(e);else if(void 0!==typeof window){a.defineCustomElements(window);var n=document.createElement("connect-modal");n.authOptions=e,document.body.appendChild(n),document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),n.remove())}))}};Object.keys(t).forEach((function(e){"default"!==e&&Object.defineProperty(exports,e,{enumerable:!0,get:function(){return t[e]}})})),exports.authenticate=y,exports.defaultAuthURL="https://app.blockstack.org",exports.getDefaultSignatureRequestOptions=M,exports.getKeys=C,exports.getOrCreateUserSession=x,exports.getStacksProvider=f,exports.getStxAddress=T,exports.getUserData=w,exports.getUserSession=S,exports.isMobile=h,exports.isStacksWalletInstalled=function(){return!!f()},exports.makeContractCallToken=I,exports.makeContractDeployToken=U,exports.makeSTXTransferToken=O,exports.openContractCall=function(e){return R(e,I)},exports.openContractDeploy=function(e){return R(e,U)},exports.openSTXTransfer=function(e){return R(e,O)},exports.openSignatureRequestPopup=function(e){return function(e,n){return z.apply(this,arguments)}(e,X)},exports.openStructuredDataSignatureRequestPopup=function(e){return function(e,n){return V.apply(this,arguments)}(e,Q)},exports.shouldUsePopup=function(){return!h()},exports.showBlockstackConnect=function(e){return ee(e)},exports.showConnect=ee,exports.showConnectStatic=function(e){var n,t;if(f())y(e);else if("function"==typeof(null==(n=window)||null==(t=n.customElements)?void 0:t.define)){void 0===customElements.get("connect-modal")&&customElements.define("connect-modal",i.ConnectModal);var r=document.createElement("connect-modal");r.authOptions=e,document.body.appendChild(r),document.addEventListener("keydown",(function e(n){"Escape"===n.key&&(document.removeEventListener("keydown",e),r.remove())}))}},exports.signMessage=X,exports.signStructuredMessage=Q;
//# sourceMappingURL=connect.cjs.production.min.js.map
